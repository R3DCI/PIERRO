<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pour lui</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        font-family: 'Playfair Display', serif;
        background: #FAF8F4;
        color: #4A3F35;
        text-align: center;
        overflow-x: hidden;
    }

    /* ---------------------------------- TITRE ---------------------------------- */
    h1 {
        margin: 28px 0 4px;
        font-size: 2.6rem;
        font-weight: 700;
        position: relative;
        animation: fadeDown 0.8s ease-out;
        text-shadow: 0 0 6px rgba(174, 139, 105, 0.35);
    }

    @keyframes fadeDown {
        from { opacity: 0; transform: translateY(-12px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    .subtitle {
        opacity: 0.75;
        font-size: 1.15rem;
        margin-bottom: 30px;
        animation: fadeDown 1s ease-out;
    }

    /* ---------------------------------- VIDEO ---------------------------------- */
    .main-video {
        width: 90%;
        max-width: 600px;
        border-radius: 14px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.18);
        animation: fadeIn 1s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to   { opacity: 1; }
    }

    /* ---------------------------------- SECTION TITLE ---------------------------------- */
    .section-title {
        text-align: left;
        width: 90%;
        margin: 45px auto 18px;
        font-size: 1.8rem;
        font-weight: 600;
        border-left: 4px solid #4A3F35;
        padding-left: 10px;
    }

    /* ---------------------------------- GALLERY ---------------------------------- */
    #gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px,1fr));
        gap: 12px;
        padding: 10px 20px 120px;
    }

    .item {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        position: relative;
        transform: translateY(10px);
        opacity: 0;
        animation: fadeUp 0.7s ease forwards;
    }

    @keyframes fadeUp {
        from { opacity: 0; transform: translateY(14px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    .item img, .item video {
        width: 100%;
        display: block;
    }

    .item:active {
        transform: scale(0.97);
    }

    .item .info {
        padding: 10px;
        font-size: 0.9rem;
        opacity: 0.85;
    }

    /* ---------------------------------- UPLOAD BUTTON ---------------------------------- */
    #upload-btn {
        position: fixed;
        bottom: 22px;
        right: 22px;
        background: #4A3F35;
        color: white;
        border: none;
        width: 68px;
        height: 68px;
        border-radius: 50%;
        font-size: 2.2rem;
        cursor: pointer;
        box-shadow: 0 5px 16px rgba(0,0,0,0.30);
        z-index: 1000;
        animation: pulse 2.2s infinite ease-in-out;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.06); }
        100% { transform: scale(1); }
    }

    /* ---------------------------------- POPUP ---------------------------------- */
    #popup {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
        z-index: 2000;
        animation: fadeInPopup 0.25s ease-out;
    }

    @keyframes fadeInPopup {
        from { opacity: 0; }
        to   { opacity: 1; }
    }

    #popup-box {
        background: white;
        width: 85%;
        max-width: 390px;
        padding: 26px;
        border-radius: 16px;
        animation: popIn 0.25s ease-out;
        box-shadow: 0 10px 24px rgba(0,0,0,0.3);
    }

    @keyframes popIn {
        from { transform: scale(0.9); opacity: 0; }
        to   { transform: scale(1); opacity: 1; }
    }

    input, textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #c9b8a8;
        border-radius: 10px;
        margin-top: 12px;
        font-size: 1rem;
        font-family: 'Playfair Display', serif;
        background: #FAF8F4;
        color: #4A3F35;
    }

    #send-btn {
        margin-top: 20px;
        width: 100%;
        padding: 14px;
        background: #4A3F35;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.25rem;
        cursor: pointer;
        transition: 0.2s;
    }

    #send-btn:active {
        transform: scale(0.96);
    }
</style>
</head>

<body>

<h1>Pour lui</h1>
<div class="subtitle">Souvenirs, images, vidéos… tout le monde peut ajouter.</div>

<!-- MAIN VIDEO -->
<video class="main-video" controls>
    <source src="TON_MONTAGE.mp4" type="video/mp4">
</video>

<!-- GALLERY -->
<div class="section-title">Souvenirs du groupe</div>
<div id="gallery"></div>

<!-- UPLOAD BUTTON -->
<button id="upload-btn" onclick="openPopup()">+</button>

<!-- POPUP -->
<div id="popup">
    <div id="popup-box">
        <h2 style="margin-top:0;">Ajouter un souvenir</h2>
        <input id="nameInput" placeholder="Prénom (optionnel)">
        <textarea id="messageInput" rows="2" placeholder="Petit message (optionnel)"></textarea>
        <input type="file" id="fileInput" accept="image/*,video/*" multiple>
        <button id="send-btn" onclick="uploadFiles()">Envoyer</button>
    </div>
</div>

<!-- FIREBASE + JS -->
<script type="module">

    /* ------------------ FIREBASE ------------------ */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { 
        getFirestore, collection, addDoc, getDocs, orderBy, query 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBUcJTY7nBbSvWbEuOoKFLvhEfui2quq2A",
        authDomain: "pierro-713fa.firebaseapp.com",
        projectId: "pierro-713fa",
        storageBucket: "pierro-713fa.appspot.com",
        messagingSenderId: "919602259394",
        appId: "1:919602259394:web:439e0ae5f932bc3a05225b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* ------------------ POPUP ------------------ */
    function openPopup() {
        document.getElementById("popup").style.display = "flex";
    }
    window.openPopup = openPopup;

    function closePopup() {
        document.getElementById("popup").style.display = "none";
    }

    /* ------------------ EXIF DATE ------------------ */
    async function getExifDate(file) {
        return new Promise(resolve => {
            try {
                const fr = new FileReader();
                fr.onload = function(e) {
                    const view = new DataView(e.target.result);
                    if (view.getUint16(0, false) != 0xFFD8) return resolve(null);

                    let offset = 2;
                    while (offset < view.byteLength) {
                        const marker = view.getUint16(offset, false);
                        offset += 2;
                        if (marker == 0xFFE1) {
                            offset += 2;
                            const exif = new TextDecoder().decode(
                                new Uint8Array(e.target.result, offset + 20, 100)
                            );
                            const match = exif.match(/(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
                            return resolve(match ? match[0] : null);
                        } else offset += view.getUint16(offset, false);
                    }
                    resolve(null);
                };
                fr.readAsArrayBuffer(file);
            } catch {
                resolve(null);
            }
        });
    }

    /* ------------------ UPLOAD ------------------ */
    async function uploadFiles() {
        const files = document.getElementById("fileInput").files;
        const name = document.getElementById("nameInput").value.trim();
        const msg = document.getElementById("messageInput").value.trim();

        if (!files.length) return alert("Choisis un fichier !");

        for (const file of files) {
            const exifDate = file.type.startsWith("image") ? await getExifDate(file) : null;
            const timestamp = exifDate ? new Date(exifDate).getTime() : Date.now();

            const storageRef = ref(storage, "souvenirs/" + Date.now() + "_" + file.name);
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);

            await addDoc(collection(db, "souvenirs"), {
                url,
                type: file.type.startsWith("video") ? "video" : "image",
                name,
                message: msg,
                date: timestamp
            });
        }

        closePopup();
        loadGallery();
    }
    window.uploadFiles = uploadFiles;

    /* ------------------ LOAD GALLERY ------------------ */
    async function loadGallery() {
        const q2 = query(collection(db, "souvenirs"), orderBy("date", "asc"));
        const snap = await getDocs(q2);

        const gallery = document.getElementById("gallery");
        gallery.innerHTML = "";

        snap.forEach(doc => {
            const d = doc.data();

            const div = document.createElement("div");
            div.className = "item";

            if (d.type === "video") {
                div.innerHTML = `<video src="${d.url}" controls></video>`;
            } else {
                div.innerHTML = `<img src="${d.url}" />`;
            }

            if (d.name || d.message) {
                div.innerHTML += `
                <div class="info">
                    ${d.name ? `<strong>${d.name}</strong><br>` : ""}
                    ${d.message ? `${d.message}` : ""}
                </div>`;
            }

            gallery.appendChild(div);
        });
    }

    loadGallery();

</script>

</body>
</html>
