<script>
const years = [2020, 2021, 2022, 2023, 2024, 2025];
const API = "https://pierro.vercel.app/api"; // ðŸ”¥ ton backend

const menu = document.getElementById("years-menu");

years.forEach(y => {
    let b = document.createElement("div");
    b.className = "year-btn";
    b.innerText = y;
    b.onclick = () => selectYear(y);
    menu.appendChild(b);
});

function highlightYear(y) {
    document.querySelectorAll(".year-btn").forEach(btn=>{
        btn.classList.remove("active");
        if (btn.innerText == y) btn.classList.add("active");
    });
}

function loadMainVideo(y) {
    document.getElementById("videoSource").src =
        `https://pierro-storage.b-cdn.net/videos/main/${y}.mp4`;
    document.getElementById("mainVideo").load();
}

async function loadPosts(year) {
    const gallery = document.getElementById("gallery");
    gallery.innerHTML = "Chargementâ€¦";

    const list = await fetch(`${API}/list?year=${year}`)
      .then(r => r.json());

    if (!list.success || list.folders.length === 0) {
        gallery.innerHTML = "Aucun souvenir pour cette annÃ©e.";
        return;
    }

    gallery.innerHTML = "";

    for (let id of list.folders) {
        const metaUrl =
          `https://pierro-storage.b-cdn.net/videos/user/${year}/${id}/meta.json`;

        let metaRes = await fetch(metaUrl);
        if (!metaRes.ok) continue;

        let post = await metaRes.json();

        const card = document.createElement("div");
        card.className = "post";

        const h = document.createElement("div");
        h.className = "post-header";
        h.innerHTML = `${post.name} â€” ${year}`;
        card.appendChild(h);

        const m = document.createElement("div");
        m.className = "post-message";
        m.innerText = post.message;
        card.appendChild(m);

        const car = document.createElement("div");
        car.className = "carousel";

        const inner = document.createElement("div");
        inner.className = "carousel-inner";

        post.files.forEach(file => {
            const item = document.createElement("div");
            item.className = "carousel-item";

            const fileUrl =
              `https://pierro-storage.b-cdn.net/videos/user/${year}/${id}/${file}`;

            if (file.endsWith(".mp4")) {
                let v = document.createElement("video");
                v.controls = true;
                v.src = fileUrl;
                item.appendChild(v);
            } else {
                let img = document.createElement("img");
                img.src = fileUrl;
                item.appendChild(img);
            }

            inner.appendChild(item);
        });

        car.appendChild(inner);
        card.appendChild(car);
        gallery.appendChild(card);
    }
}

function selectYear(y) {
    highlightYear(y);
    loadMainVideo(y);
    loadPosts(y);
}

selectYear(2025);

// âœš UPLOAD VISITEUR
async function sendVisitorPost() {
    const name = document.getElementById("visitor-name").value.trim();
    const message = document.getElementById("visitor-message").value.trim();
    const year = document.getElementById("visitor-year").value.trim();
    const files = document.getElementById("visitor-files").files;

    const status = document.getElementById("visitor-status");

    if (!name || !message || !year)
        return status.innerHTML = "Veuillez remplir tous les champs.";

    if (!files.length)
        return status.innerHTML = "Ajoutez au moins un fichier.";

    status.innerHTML = "Envoiâ€¦";

    const form = new FormData();
    form.append("name", name);
    form.append("message", message);
    form.append("year", year);
    for (let f of files) form.append("files", f);

    try {
        const res = await fetch(`${API}/upload-visitors`, {
            method: "POST",
            body: form
        }).then(r => r.json());

        if (!res.success)
            return status.innerHTML = "Erreur lors de lâ€™envoi.";

        status.innerHTML = "âœ” Souvenir ajoutÃ© !";
        setTimeout(() => closeVisitorPopup(), 1200);
        selectYear(year);

    } catch {
        status.innerHTML = "Erreur lors de lâ€™envoi.";
    }
}
</script>
